{% extends 'owners/base.html' %}

{% block title %}Kitchen Settings{% endblock %}

{% block content %}
<h2>Kitchen Settings</h2>

<!-- Form to Add New Kitchen -->
<form method="POST" action="{% url 'add_kitchen' restaurant.id %}">
    {% csrf_token %}
    <div class="mb-3">
        <label for="kitchenName" class="form-label">New Kitchen Name</label>
        <input type="text" class="form-control" id="kitchenName" name="name" required>
    </div>
    <button type="submit" class="btn btn-primary">Add Kitchen</button>
</form>

<hr>

<!-- List of Kitchens and Their Items -->
<pre>
    {{ kitchens|pprint }}
</pre>

{% for kitchen in kitchens %}
    <pre>
        {{ kitchen.id|pprint }}
        {{ kitchen_items.1|pprint }}
    </pre>
    <div class="mb-4">
        <h4>{{ kitchen.name }}</h4>
        <ul class="list-group">
            {% with id=kitchen.id%}
                {% for item in kitchen_items.ID %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ item.name }}
                        <form method="POST" action="{% url 'delete_item_from_kitchen' restaurant.id kitchen.id item.id %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </li>
                {% empty %}
                    <li class="list-group-item">No items in this kitchen.</li>
                {% endfor %}
            {% endwith  %}
        </ul>
        <!-- Add item to kitchen form -->
        <form method="POST" action="{% url 'add_item_to_kitchen' restaurant.id kitchen.id %}" class="mt-3">
            {% csrf_token %}
            <div class="input-group">
                <select class="form-select" name="item_id" required>
                    <option value="" disabled selected>Select item</option>
                    {% for item in items_not_in_kitchen.kitchen.id %}
                        <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </div>
        </form>
    </div>
{% endfor %}

{% endblock %}

{% block extra_scripts %}
<script>
function showAddItemForm(kitchenId) {
    const form = document.getElementById(`add-item-form-${kitchenId}`);
    const select = document.getElementById(`item-select-${kitchenId}`);
    
    // Show the form
    form.style.display = 'block';
    
    // Fetch the items not yet in this kitchen
    fetch(`/restaurant/{{ restaurant.id }}/get_items_for_kitchen/${kitchenId}/`)
        .then(response => response.json())
        .then(data => {
            select.innerHTML = ''; // Clear the existing options
            data.items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching items:', error));
}

function addItemToKitchen(kitchenId) {
    const select = document.getElementById(`item-select-${kitchenId}`);
    const itemId = select.value;
    
    fetch(`/restaurant/{{ restaurant.id }}/add_item_to_kitchen/${kitchenId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `item_id=${itemId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Item added to kitchen!');
            location.reload(); // Reload to update the list
        } else {
            alert('Failed to add item to kitchen.');
        }
    })
    .catch(error => console.error('Error adding item:', error));
}
</script>
{% endblock %}
